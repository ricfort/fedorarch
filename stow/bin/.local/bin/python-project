#!/usr/bin/env bash
set -euo pipefail

PROJECT="${1:-$(basename "$(pwd)")}"

# Sanitize project name - prevent directory traversal and special characters
if [[ "$PROJECT" =~ [/] ]] || [[ "$PROJECT" == "." ]] || [[ "$PROJECT" == ".." ]]; then
    echo "Error: Invalid project name. Cannot contain slashes or be . or .."
    exit 1
fi

# Only allow safe characters in project names
if ! [[ "$PROJECT" =~ ^[a-zA-Z0-9_-]+$ ]]; then
    echo "Error: Invalid project name. Only alphanumeric characters, underscores, and dashes are allowed."
    exit 1
fi

mkdir -p "$PROJECT" && cd "$PROJECT"

# Check if mise is available
if ! command -v mise >/dev/null 2>&1; then
    echo "Error: mise is not installed or not in PATH"
    exit 1
fi

# Check if uv is available
if ! command -v uv >/dev/null 2>&1; then
    echo "Error: uv is not installed or not in PATH"
    exit 1
fi

# Setup mise python
mise use python@latest && mise trust

# Get python path from mise
PYTHON_PATH=$(mise where python)
if [ -z "$PYTHON_PATH" ]; then
    echo "Error: Could not find python path from mise"
    exit 1
fi

# Create virtual environment
uv venv --python "$PYTHON_PATH"

# Activate and install packages if file exists
if [ -f ~/.config/mise/default-python-packages.txt ]; then
    source .venv/bin/activate
    uv pip install -r ~/.config/mise/default-python-packages.txt
else
    echo "Warning: ~/.config/mise/default-python-packages.txt not found, skipping package installation"
fi

echo "Python project '$PROJECT' ready! Run: nvim ."
