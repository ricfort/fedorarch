#!/usr/bin/env bash
set -euo pipefail

if [ $# -lt 2 ]; then
    echo "Usage: $0 <name> <url> [icon_url] [class]"
    echo "Example: $0 'Gmail' 'https://mail.google.com' 'https://example.com/icon.png' 'gmail'"
    exit 1
fi

NAME="$1"
URL="$2"
ICON_URL="${3:-}"
CLASS="${4:-$1}"

mkdir -p ~/.local/share/applications ~/.local/share/icons/webapps

# Download icon if URL provided
if [ -n "$ICON_URL" ]; then
    curl -sL "$ICON_URL" -o "$HOME/.local/share/icons/webapps/${CLASS}.png" || {
        echo "Warning: Failed to download icon, continuing without icon"
    }
fi

# Create desktop entry
cat > ~/.local/share/applications/${CLASS}.desktop << EOF
[Desktop Entry]
Name=$NAME
Exec=/usr/bin/chromium --app=$URL --class=$CLASS
Icon=$HOME/.local/share/icons/webapps/${CLASS}.png
Type=Application
Categories=Network;
StartupWMClass=$CLASS
EOF

chmod +x ~/.local/share/applications/${CLASS}.desktop
update-desktop-database ~/.local/share/applications/ 2>/dev/null || true
echo "WebApp '$NAME' created!"
