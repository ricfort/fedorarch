#!/usr/bin/env bash
set -euo pipefail

# Interactive webapp creation

# Function to send notification
send_notification() {
    local title="$1"
    local message="$2"
    local urgency="${3:-normal}"
    
    # Ensure we have display environment variables
    export DISPLAY="${DISPLAY:-:0}"
    export WAYLAND_DISPLAY="${WAYLAND_DISPLAY:-wayland-0}"
    export XDG_SESSION_TYPE="${XDG_SESSION_TYPE:-wayland}"
    
    if command -v notify-send >/dev/null 2>&1; then
        # Send notification in background but wait a tiny bit to ensure it's sent
        (notify-send "$title" "$message" --urgency="$urgency" --expire-time=5000 2>&1 &)
        sleep 0.1
    fi
}

# Function to handle errors
handle_error() {
    local exit_code=$?
    send_notification "WebApp Creation Failed" "Script exited with error (code: $exit_code)\nCheck terminal for details" "critical"
    exit "$exit_code"
}

# Trap errors to send notification
trap 'handle_error' ERR
if [ $# -eq 0 ]; then
    echo "=== Create WebApp ==="
    echo ""
    
    # Prompt for name
    read -p "App name: " NAME
    if [ -z "$NAME" ]; then
        echo "Error: App name is required"
        send_notification "WebApp Creation Failed" "App name is required" "critical"
        exit 1
    fi
    
    # Prompt for URL
    read -p "URL: " URL
    if [ -z "$URL" ]; then
        echo "Error: URL is required"
        send_notification "WebApp Creation Failed" "URL is required" "critical"
        exit 1
    fi
    
    # Ensure URL has protocol
    if [[ ! "$URL" =~ ^https?:// ]]; then
        URL="https://$URL"
        echo "Added https:// to URL: $URL"
    fi
    
    # Prompt for icon (optional)
    read -p "Icon URL (optional, press Enter to skip): " ICON_URL
    
    # Prompt for class (optional, defaults to name)
    read -p "Class name (optional, defaults to app name): " CLASS
    CLASS="${CLASS:-$NAME}"
    
    # Prompt for profile
    echo ""
    echo "Select profile:"
    echo "  1) Personal (Default)"
    echo "  2) Work"
    read -p "Enter choice [1]: " choice
    case "${choice:-1}" in
        1|Personal|personal|Default|default)
            PROFILE="Default"
            ;;
        2|Work|work)
            PROFILE="Work"
            ;;
        *)
            echo "Invalid choice, using Personal (Default)"
            PROFILE="Default"
            ;;
    esac
else
    # Non-interactive mode (command line arguments)
    if [ $# -lt 2 ]; then
        echo "Usage: $0 <name> <url> [icon_url] [class] [--profile=PROFILE]"
        echo "Example: $0 'Gmail' 'https://mail.google.com' 'https://example.com/icon.png' 'gmail'"
        echo "Example: $0 'Work Gmail' 'https://mail.google.com' '' 'gmail-work' --profile=Work"
        echo ""
        echo "Or run without arguments for interactive mode:"
        echo "  $0"
        exit 1
    fi
    
    NAME="$1"
    URL="$2"
    
    # Ensure URL has protocol
    if [[ ! "$URL" =~ ^https?:// ]]; then
        URL="https://$URL"
    fi
    
    ICON_URL="${3:-}"
    CLASS="${4:-$1}"
    PROFILE=""
    
    # Parse profile argument
    for arg in "$@"; do
        if [[ "$arg" == --profile=* ]]; then
            PROFILE="${arg#--profile=}"
        fi
    done
    
    # If profile not specified, prompt user
    if [ -z "$PROFILE" ]; then
        echo "Select profile for '$NAME':"
        echo "  1) Personal (Default)"
        echo "  2) Work"
        read -p "Enter choice [1]: " choice
        case "${choice:-1}" in
            1|Personal|personal|Default|default)
                PROFILE="Default"
                ;;
            2|Work|work)
                PROFILE="Work"
                ;;
            *)
                echo "Invalid choice, using Personal (Default)"
                PROFILE="Default"
                ;;
        esac
    fi
fi

# Create directories directly in user's local share (no stow)
WEBAPPS_APPS_DIR="$HOME/.local/share/applications"
WEBAPPS_ICONS_DIR="$HOME/.local/share/icons/webapps"

mkdir -p "$WEBAPPS_APPS_DIR"
mkdir -p "$WEBAPPS_ICONS_DIR"

# Download icon if URL provided
ICON_FILE=""
if [ -n "$ICON_URL" ]; then
    ICON_FILE="$WEBAPPS_ICONS_DIR/${CLASS}.png"
    # Validate URL format before downloading
    if [[ "$ICON_URL" =~ ^https?:// ]]; then
        if ! curl -sL --max-time 10 "$ICON_URL" -o "$ICON_FILE"; then
            echo "Warning: Failed to download icon, continuing without icon"
            ICON_FILE=""
        fi
    else
        echo "Warning: Invalid icon URL format (must be http:// or https://), skipping icon"
        ICON_FILE=""
    fi
fi

# Create desktop entry directly in ~/.local/share/applications
DESKTOP_FILE="$WEBAPPS_APPS_DIR/${CLASS}.desktop"
cat > "$DESKTOP_FILE" << EOF
[Desktop Entry]
Version=1.0
Name=$NAME
Comment=Web application: $URL
Exec=chromium-browser --profile-directory=$PROFILE --app=$URL --class=$CLASS
Icon=$HOME/.local/share/icons/webapps/${CLASS}.png
Type=Application
Categories=Network;WebApp;
StartupWMClass=$CLASS
NoDisplay=false
Terminal=false
EOF

chmod +x "$DESKTOP_FILE"

# Update desktop database
if update-desktop-database ~/.local/share/applications/ 2>/dev/null; then
    echo "Desktop database updated"
else
    echo "Warning: Failed to update desktop database"
fi

# Verify desktop file was created
if [ -f "$DESKTOP_FILE" ]; then
    echo ""
    echo "✓ WebApp '$NAME' created with profile '$PROFILE'!"
    echo "  Desktop entry: $DESKTOP_FILE"
    if [ -n "$ICON_FILE" ] && [ -f "$ICON_FILE" ]; then
        echo "  Icon: $ICON_FILE"
    fi
    echo "  Available in Super+Space launcher"
    send_notification "WebApp Created" "$NAME (Profile: $PROFILE)\nAvailable in Super+Space" "normal"
else
    echo ""
    echo "✗ Failed to create WebApp '$NAME'"
    echo "  Desktop file should be at: $DESKTOP_FILE"
    send_notification "WebApp Creation Failed" "Could not create '$NAME'\nCheck terminal output" "critical"
    exit 1
fi
